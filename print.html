<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>도트 그림 키링 프린트</title>
  <link rel="icon" href="data:,">
  <script src="./lib/base62.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: "Segoe UI", system-ui, sans-serif;
      background: #f2f4f8;
      color: #1f2933;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #print_container {
      background: #ffffff;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 20px 60px rgba(15, 17, 21, 0.18);
      width: min(92vw, 520px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    #print_container h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
      color: #0f1115;
      text-align: center;
    }
    #preview_wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
    }
    #preview_canvas {
      width: min(100%, 360px);
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      box-shadow: inset 0 0 0 1px rgba(15,17,21,0.1);
      background: #ffffff;
    }
    #info_panel {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }
    #view_link_container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #view_link_container label {
      font-size: 0.9rem;
      color: #475569;
    }
    #view_link {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d0d5dd;
      font-size: 0.92rem;
      color: #1f2933;
      background: #f8fafc;
    }
    #actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }
    button {
      padding: 10px 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    #btn_print {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
    }
    #btn_print:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }
    #btn_save_image, #btn_copy_view {
      background: #e2e8f0;
      color: #1f2933;
      box-shadow: 0 4px 12px rgba(15, 17, 21, 0.12);
    }
    #btn_save_image:hover, #btn_copy_view:hover {
      transform: translateY(-1px);
      background: #cbd5f5;
    }
    #base62_code {
      font-family: "JetBrains Mono", "Fira Code", monospace;
      font-size: 0.85rem;
      color: #64748b;
      word-break: break-all;
      text-align: center;
    }
    #empty_state {
      font-size: 1rem;
      color: #475569;
      text-align: center;
    }
    @media print {
      body {
        background: #ffffff;
      }
      #print_container {
        box-shadow: none;
        width: 100%;
        padding: 0;
      }
      #actions, #view_link_container {
        display: none !important;
      }
      #preview_canvas {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="print_container">
    <h1>프린트용 키링 이미지</h1>
    <div id="preview_wrapper">
      <canvas id="preview_canvas" width="512" height="512"></canvas>
    </div>
    <div id="base62_code"></div>
    <div id="actions">
      <button id="btn_print">프린트</button>
      <button id="btn_save_image">이미지 저장</button>
      <button id="btn_copy_view">뷰 링크 복사</button>
    </div>
    <div id="view_link_container" hidden>
      <label for="view_link">상호작용 화면 (view.html)</label>
      <input id="view_link" readonly>
    </div>
    <div id="empty_state" hidden>그림 데이터가 없습니다.</div>
  </div>

  <script>
    const previewCanvas = document.getElementById('preview_canvas');
    const previewCtx = previewCanvas.getContext('2d');
    const btnPrint = document.getElementById('btn_print');
    const btnSaveImage = document.getElementById('btn_save_image');
    const copyViewBtn = document.getElementById('btn_copy_view');
    const viewLinkContainer = document.getElementById('view_link_container');
    const viewLinkInput = document.getElementById('view_link');
    const base62CodeDiv = document.getElementById('base62_code');
    const emptyState = document.getElementById('empty_state');

    const GRID_SIZE = 10;
    const PIXEL_COUNT = GRID_SIZE * GRID_SIZE;
    const BITS_PER_PIXEL = 3;

    const PALETTE_COLORS = [
      '#FFFFFF', // c0 - White
      '#1F2937', // c1 - Black
      '#EF4444', // c2 - Red
      '#F97316', // c3 - Orange
      '#FACC15', // c4 - Yellow
      '#22C55E', // c5 - Green
      '#3B82F6', // c6 - Blue
      '#8B5CF6'  // c7 - Purple
    ];

    let viewUrl = '';

    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const b62 = urlParams.get('b62');

      if (b62) {
        renderPixelArt(b62);
        base62CodeDiv.textContent = `Base62 코드: ${b62}`;
        viewUrl = new URL('view.html', window.location.href).href + '?b62=' + b62;
        viewLinkInput.value = viewUrl;
        viewLinkContainer.hidden = false;
        emptyState.hidden = true;
        setActionsEnabled(true);
      } else {
        clearCanvas();
        base62CodeDiv.textContent = '';
        viewLinkContainer.hidden = true;
        viewLinkInput.value = '';
        emptyState.hidden = false;
        setActionsEnabled(false);
      }

      btnPrint.addEventListener('click', () => window.print());
      btnSaveImage.addEventListener('click', saveImage);
      copyViewBtn.addEventListener('click', copyViewLink);
    });

    function setActionsEnabled(enabled) {
      btnPrint.disabled = !enabled;
      btnSaveImage.disabled = !enabled;
      copyViewBtn.disabled = !enabled;
    }

    function renderPixelArt(b62String) {
      clearCanvas();
      const decodedBigInt = base62.decode(b62String);
      const binaryString = decodedBigInt.toString(2).padStart(PIXEL_COUNT * BITS_PER_PIXEL, '0');
      const pixelSize = previewCanvas.width / GRID_SIZE;

      for (let i = 0; i < PIXEL_COUNT; i++) {
        const offset = i * BITS_PER_PIXEL;
        const colorBits = binaryString.substring(offset, offset + BITS_PER_PIXEL);
        const colorIndex = parseInt(colorBits, 2);
        const row = Math.floor(i / GRID_SIZE);
        const col = i % GRID_SIZE;
        previewCtx.fillStyle = PALETTE_COLORS[colorIndex] ?? PALETTE_COLORS[0];
        previewCtx.fillRect(col * pixelSize, row * pixelSize, pixelSize, pixelSize);
      }
    }

    function clearCanvas() {
      previewCtx.fillStyle = '#FFFFFF';
      previewCtx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
    }

    function saveImage() {
      const link = document.createElement('a');
      link.download = 'keyring-art.png';
      link.href = previewCanvas.toDataURL('image/png');
      link.click();
    }

    function copyViewLink() {
      if (!viewUrl) {
        return;
      }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(viewUrl)
          .then(() => alert('view.html 링크가 복사되었습니다.'))
          .catch(fallbackCopyViewLink);
      } else {
        fallbackCopyViewLink();
      }
    }

    function fallbackCopyViewLink() {
      viewLinkInput.focus();
      viewLinkInput.select();
      viewLinkInput.setSelectionRange(0, viewLinkInput.value.length);
      try {
        document.execCommand('copy');
        alert('view.html 링크가 복사되었습니다.');
      } catch (err) {
        alert('복사에 실패했습니다. 직접 선택해서 복사해주세요.');
      }
    }
  </script>
</body>
</html>
