<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>도트 그림 키링 프린트</title>
  <link rel="icon" href="data:,">
  <script src="./lib/base62.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: "Segoe UI", system-ui, sans-serif;
      background: #111827;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e2e8f0;
    }
    #print_container {
      width: min(92vw, 540px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    #preview_wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 18px;
      border-radius: 22px;
      background: #0f172a;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.18), 0 30px 80px rgba(15, 23, 42, 0.55);
    }
    #preview_canvas {
      width: min(100%, 480px);
      aspect-ratio: 110 / 162.8;
      display: block;
      background: transparent;
      border: none;
      image-rendering: pixelated;
    }
    #actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }
    #view_link_container {
      width: 100%;
      text-align: center;
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.9);
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }
    #view_link_row {
      width: 100%;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }
    #view_link {
      color: #facc15;
      text-decoration: none;
      word-break: break-all;
      flex: 1;
    }
    #view_link:hover {
      text-decoration: underline;
    }
    #btn_copy_view {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: rgba(148, 163, 184, 0.2);
      color: #e2e8f0;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      white-space: nowrap;
    }
    #btn_copy_view:hover:not(:disabled) {
      background: rgba(248, 250, 252, 0.35);
      transform: translateY(-1px);
    }
    #btn_copy_view:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button {
      padding: 12px 22px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.96rem;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    #btn_print {
      background: linear-gradient(135deg, #f97316, #facc15);
      color: #111827;
      box-shadow: 0 10px 25px rgba(249, 115, 22, 0.35);
    }
    #btn_print:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 35px rgba(249, 115, 22, 0.45);
    }
    #btn_save_image {
      background: rgba(15, 23, 42, 0.72);
      color: #f8fafc;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4);
    }
    #btn_save_image:hover {
      transform: translateY(-1px);
      background: rgba(30, 41, 59, 0.85);
    }
    #empty_state {
      font-size: 0.95rem;
      color: rgba(226, 232, 240, 0.85);
      text-align: center;
    }
    @media print {
      body {
        background: #ffffff;
      }
      #print_container {
        box-shadow: none;
        width: 100%;
        padding: 0;
      }
      #actions {
        display: none !important;
      }
      #preview_canvas {
        width: 11cm;
        height: 16.28cm;
      }
    }
  </style>
</head>
<body>
  <div id="print_container">
    <div id="preview_wrapper">
      <canvas id="preview_canvas" width="1299" height="1923"></canvas>
    </div>
    <div id="actions">
      <button id="btn_print">프린트</button>
      <button id="btn_save_image">이미지 저장</button>
    </div>
    <div id="view_link_container" hidden>
      <div>상호작용 화면 주소</div>
      <div id="view_link_row">
        <a id="view_link" target="_blank" rel="noopener"></a>
        <button id="btn_copy_view" type="button">주소 복사</button>
      </div>
    </div>
    <div id="empty_state" hidden>그림 데이터가 없습니다.</div>
  </div>

  <script>
    const previewCanvas = document.getElementById('preview_canvas');
    const previewCtx = previewCanvas.getContext('2d');
    const btnPrint = document.getElementById('btn_print');
    const btnSaveImage = document.getElementById('btn_save_image');
    const emptyState = document.getElementById('empty_state');
    const viewLinkContainer = document.getElementById('view_link_container');
    const viewLinkAnchor = document.getElementById('view_link');
    const btnCopyView = document.getElementById('btn_copy_view');

    const GRID_SIZE = 10;
    const PIXEL_COUNT = GRID_SIZE * GRID_SIZE;
    const BITS_PER_PIXEL = 3;
    const MM_PER_INCH = 25.4;
    const PRINT_DPI = 300;
    const SCALE_FACTOR = 1.1;
    const BASE_CARD_MM = { width: 100, height: 148 };
    const BASE_PHOTO_MM = { width: 35, height: 45 };
    const CARD_MM = {
      width: BASE_CARD_MM.width * SCALE_FACTOR,
      height: BASE_CARD_MM.height * SCALE_FACTOR
    };
    const PHOTO_MM = {
      width: BASE_PHOTO_MM.width * SCALE_FACTOR,
      height: BASE_PHOTO_MM.height * SCALE_FACTOR
    };
    const DUPLICATE_COUNT = 2;
    const OUTPUT_PX = {
      width: Math.round((CARD_MM.width / MM_PER_INCH) * PRINT_DPI),
      height: Math.round((CARD_MM.height / MM_PER_INCH) * PRINT_DPI)
    };

    const PALETTE_COLORS = [
      '#FFFFFF', // c0 - White
      '#1F2937', // c1 - Black
      '#EF4444', // c2 - Red
      '#F97316', // c3 - Orange
      '#FACC15', // c4 - Yellow
      '#22C55E', // c5 - Green
      '#3B82F6', // c6 - Blue
      '#8B5CF6'  // c7 - Purple
    ];

    let viewUrl = '';

    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const b62 = urlParams.get('b62');

      configureCanvas();

      if (b62) {
        renderPixelArt(b62);
        viewUrl = new URL('view.html', window.location.href).href + '?b62=' + b62;
        viewLinkAnchor.textContent = viewUrl;
        viewLinkAnchor.href = viewUrl;
        viewLinkContainer.hidden = false;
        btnCopyView.disabled = false;
        emptyState.hidden = true;
        setActionsEnabled(true);
      } else {
        clearCanvas();
        viewUrl = '';
        viewLinkAnchor.textContent = '';
        viewLinkAnchor.removeAttribute('href');
        viewLinkContainer.hidden = true;
        btnCopyView.disabled = true;
        emptyState.hidden = false;
        setActionsEnabled(false);
      }

      btnPrint.addEventListener('click', () => window.print());
      btnSaveImage.addEventListener('click', saveImage);
      btnCopyView.addEventListener('click', copyViewLink);
    });

    function setActionsEnabled(enabled) {
      btnPrint.disabled = !enabled;
      btnSaveImage.disabled = !enabled;
    }

    function configureCanvas() {
      previewCanvas.width = OUTPUT_PX.width;
      previewCanvas.height = OUTPUT_PX.height;
    }

    function renderPixelArt(b62String) {
      clearCanvas();

      const decodedBigInt = base62.decode(b62String);
      const binaryString = decodedBigInt.toString(2).padStart(PIXEL_COUNT * BITS_PER_PIXEL, '0');

      const pxPerMm = previewCanvas.width / CARD_MM.width;
      const photoWidthPx = PHOTO_MM.width * pxPerMm;
      const photoHeightPx = PHOTO_MM.height * pxPerMm;
      const squareSizePx = photoWidthPx;
      const horizontalMarginPx = (previewCanvas.width - photoWidthPx) / 2;
      const verticalSpacingPx = (previewCanvas.height - (photoHeightPx * DUPLICATE_COUNT)) / (DUPLICATE_COUNT + 1);

      previewCtx.imageSmoothingEnabled = false;

      for (let copyIndex = 0; copyIndex < DUPLICATE_COUNT; copyIndex++) {
        const photoX = horizontalMarginPx;
        const photoY = verticalSpacingPx + copyIndex * (photoHeightPx + verticalSpacingPx);
        const squareY = photoY + (photoHeightPx - squareSizePx) / 2;

        drawPhotoFrame({
          x: photoX,
          y: photoY,
          width: photoWidthPx,
          height: photoHeightPx,
          pxPerMm
        });

        const pixelSize = squareSizePx / GRID_SIZE;
        for (let i = 0; i < PIXEL_COUNT; i++) {
          const offset = i * BITS_PER_PIXEL;
          const colorBits = binaryString.substring(offset, offset + BITS_PER_PIXEL);
          const colorIndex = parseInt(colorBits, 2);
          const row = Math.floor(i / GRID_SIZE);
          const col = i % GRID_SIZE;
          previewCtx.fillStyle = PALETTE_COLORS[colorIndex] ?? PALETTE_COLORS[0];
          previewCtx.fillRect(
            photoX + col * pixelSize,
            squareY + row * pixelSize,
            pixelSize,
            pixelSize
          );
        }

        drawSquareGuide({ x: photoX, y: squareY, size: squareSizePx, pxPerMm });
      }

      drawCutGuides(pxPerMm);
    }

    function clearCanvas() {
      previewCtx.fillStyle = '#FFFFFF';
      previewCtx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
    }

    function drawPhotoFrame({ x, y, width, height, pxPerMm }) {
      previewCtx.save();
      previewCtx.fillStyle = '#ffffff';
      previewCtx.fillRect(x, y, width, height);
      previewCtx.restore();

      previewCtx.save();
      previewCtx.strokeStyle = '#1d4ed8';
      previewCtx.lineWidth = Math.max(2, pxPerMm * 0.2);
      previewCtx.strokeRect(x, y, width, height);
      previewCtx.restore();
    }

    function drawSquareGuide({ x, y, size, pxPerMm }) {
      previewCtx.save();
      previewCtx.strokeStyle = 'rgba(15, 17, 21, 0.18)';
      previewCtx.setLineDash([pxPerMm * 2, pxPerMm * 1.3]);
      previewCtx.lineWidth = Math.max(1, pxPerMm * 0.12);
      previewCtx.strokeRect(x, y, size, size);
      previewCtx.restore();
    }

    function drawCutGuides(pxPerMm) {
      const borderStroke = Math.max(2, pxPerMm * 0.25);
      const dashSize = pxPerMm * 3;
      const inset = borderStroke / 2;

      previewCtx.save();
      previewCtx.strokeStyle = '#64748b';
      previewCtx.setLineDash([dashSize, dashSize * 0.8]);
      previewCtx.lineWidth = borderStroke;
      previewCtx.strokeRect(
        inset,
        inset,
        previewCanvas.width - borderStroke,
        previewCanvas.height - borderStroke
      );
      previewCtx.restore();
    }

    function saveImage() {
      const link = document.createElement('a');
  link.download = 'keyring-print-110.png';
      link.href = previewCanvas.toDataURL('image/png');
      link.click();
    }

    function copyViewLink() {
      if (!viewUrl) {
        return;
      }
      const copyText = viewUrl.replace(/^https?:\/\//i, '');
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(copyText)
          .then(() => alert('주소가 복사되었습니다.'))
          .catch(() => fallbackCopy(copyText));
      } else {
        fallbackCopy(copyText);
      }
    }

    function fallbackCopy(text) {
      const tempInput = document.createElement('textarea');
      tempInput.value = text;
      document.body.appendChild(tempInput);
      tempInput.select();
      try {
        document.execCommand('copy');
        alert('주소가 복사되었습니다.');
      } catch (error) {
        alert('복사에 실패했습니다. 직접 선택해서 복사해주세요.');
      } finally {
        document.body.removeChild(tempInput);
      }
    }
  </script>
</body>
</html>
