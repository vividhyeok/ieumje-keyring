<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>도트 그림 키링 제작</title>
    <link rel="icon" href="data:,">
    <script src="./lib/jquery-2.1.3.min.js"></script>
    <script src="./lib/base62.js"></script>
    <script src="./lib/qrcode.min.js"></script>
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            background: linear-gradient(160deg, #eef2ff 0%, #f8fafc 60%, #e0f2fe 100%);
            color: #1f2933;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: stretch;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        #main_container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            height: 100%;
            padding: calc(var(--safe-area-inset-top) + 24px) 20px calc(var(--safe-area-inset-bottom) + 32px);
            gap: 24px;
            overflow-y: auto;
        }

        #main_container::-webkit-scrollbar {
            display: none;
        }

        #bit_area {
            width: min(90vw, 92vmin);
            height: min(90vw, 92vmin);
            max-width: 420px;
            max-height: 420px;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            border-radius: 24px;
            background: #ffffff;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
            border: 1px solid rgba(148, 163, 184, 0.35);
            touch-action: none;
            overflow: hidden;
        }

        .bit_grid {
            border: 1px solid rgba(226, 232, 240, 0.75);
            cursor: pointer;
            transition: transform 0.08s ease;
        }

        .bit_grid:active {
            transform: scale(0.96);
        }

        #control_panel {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #color_panel {
            width: 100%;
            max-width: 420px;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 16px;
            padding: 8px 2px;
            justify-items: center;
        }

        .color_dot {
            width: clamp(44px, 18vw, 54px);
            height: clamp(44px, 18vw, 54px);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            box-shadow: 0 8px 22px rgba(15, 23, 42, 0.18);
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .color_dot:active {
            transform: scale(1.08);
        }

        .color_dot.active {
            border-color: #2563eb;
            transform: scale(1.15);
        }

        .button {
            width: min(82vw, 340px);
            font-size: 1.08rem;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border: none;
            padding: 16px 24px;
            border-radius: 999px;
            cursor: pointer;
            box-shadow: 0 16px 32px rgba(37, 99, 235, 0.35);
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .button:active {
            transform: translateY(1px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.3);
        }

        .button:focus-visible {
            outline: 3px solid rgba(37, 99, 235, 0.6);
            outline-offset: 4px;
        }

        #cover {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            justify-content: center;
            align-items: center;
            background: rgba(15, 17, 21, 0.38);
            backdrop-filter: blur(6px);
            padding: 24px;
        }

        .qr_card {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: min(88vw, 320px);
            padding: 28px 24px 32px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            box-shadow: 0 20px 48px rgba(17, 24, 39, 0.22);
            text-align: center;
            animation: fadeIn 0.32s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.92);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .qr_card h2 {
            margin: 0;
            font-size: clamp(1.25rem, 4vw, 1.5rem);
            font-weight: 700;
            color: #1f2933;
        }

        .qr_instruction {
            margin: 16px 0 20px;
            font-size: clamp(0.95rem, 3.6vw, 1.05rem);
            font-weight: 600;
            color: #374151;
            letter-spacing: -0.01em;
        }

        #qrcode {
            width: min(50vw, 220px);
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            background: #ffffff;
            box-shadow: 0 12px 30px rgba(15, 17, 21, 0.14);
            padding: 12px;
        }

        #qrcode canvas,
        #qrcode img {
            width: 100% !important;
            height: 100% !important;
        }

        #btn_close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 34px;
            height: 34px;
            background: rgba(15, 17, 21, 0.08);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: 600;
            color: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        #btn_close:active {
            background: rgba(15, 17, 21, 0.16);
            transform: scale(0.96);
        }

        #btn_close:focus-visible {
            outline: 2px solid rgba(37, 99, 235, 0.7);
            outline-offset: 2px;
        }

        .c0 { background-color: #FFFFFF; }
        .c1 { background-color: #1F2937; }
        .c2 { background-color: #EF4444; }
        .c3 { background-color: #F97316; }
        .c4 { background-color: #FACC15; }
        .c5 { background-color: #22C55E; }
        .c6 { background-color: #3B82F6; }
        .c7 { background-color: #8B5CF6; }

        @media (min-width: 640px) {
            #main_container {
                padding-left: 32px;
                padding-right: 32px;
            }

            .color_dot {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div id="main_container">
        <div id="bit_area" aria-label="10x10 픽셀 그리드"></div>
        <div id="control_panel">
            <div id="color_panel" aria-label="색상 선택"></div>
            <button class="button" id="btn_complete" type="button">완료</button>
        </div>
    </div>

    <div id="cover" role="dialog" aria-modal="true">
        <div class="qr_card">
            <button id="btn_close" type="button" aria-label="닫기">×</button>
            <h2>완성!</h2>
            <p class="qr_instruction">운영자에게 QR코드를 보여주세요.</p>
            <div id="qrcode" aria-label="체험 결과 QR 코드"></div>
        </div>
    </div>

    <script>
        const GRID_SIZE = 10;
        const PIXEL_COUNT = GRID_SIZE * GRID_SIZE;
        const BITS_PER_PIXEL = 3;

        const PALETTE = [
            { name: 'WHITE', class: 'c0' },
            { name: 'BLACK', class: 'c1' },
            { name: 'RED', class: 'c2' },
            { name: 'ORANGE', class: 'c3' },
            { name: 'YELLOW', class: 'c4' },
            { name: 'GREEN', class: 'c5' },
            { name: 'BLUE', class: 'c6' },
            { name: 'PURPLE', class: 'c7' }
        ];
        let currentColorIndex = 1;

        let isDrawing = false;

        $(document).ready(function () {
            createGrid();
            createPalette();

            function fillCell(cell) {
                $(cell).data('colorIndex', currentColorIndex);
                $(cell).attr('class', 'bit_grid ' + PALETTE[currentColorIndex].class);
            }

            $('#bit_area').on("mousedown touchstart", '.bit_grid', function (e) {
                e.preventDefault();
                isDrawing = true;
                fillCell(this);
            });

            $('#bit_area').on("mousemove touchmove", function (e) {
                e.preventDefault();
                if (isDrawing) {
                    const target = document.elementFromPoint(e.clientX || e.touches[0].clientX, e.clientY || e.touches[0].clientY);
                    if ($(target).hasClass('bit_grid')) {
                        fillCell(target);
                    }
                }
            });

            $(document).on("mouseup touchend", function () {
                isDrawing = false;
            });

            $('#color_panel').on('click', '.color_dot', function() {
                currentColorIndex = $(this).data('colorIndex');
                $('#color_panel .color_dot').removeClass('active');
                $(this).addClass('active');
            });

            $('#btn_complete').click(function () {
                generateLink();
                $('#cover').css('display', 'flex');
            });

            $('#btn_close').click(function () {
                $('#cover').hide();
            });
        });

        function createGrid() {
            const bitArea = $('#bit_area');
            bitArea.empty();
            for (let i = 0; i < PIXEL_COUNT; i++) {
                const gridCell = $('<div>')
                    .addClass('bit_grid c0') // Start with white
                    .data('colorIndex', 0); // 0 indicates white
                bitArea.append(gridCell);
            }
        }

        function createPalette() {
            const colorPanel = $('#color_panel');
            PALETTE.forEach((color, index) => {
                const colorDot = $('<div>')
                    .addClass('color_dot ' + color.class)
                    .data('colorIndex', index);
                if (index === currentColorIndex) {
                    colorDot.addClass('active');
                }
                colorPanel.append(colorDot);
            });
        }

        function generateLink() {
            let binaryString = '';
            $('.bit_grid').each(function() {
                const colorIndex = $(this).data('colorIndex');
                binaryString += colorIndex.toString(2).padStart(BITS_PER_PIXEL, '0');
            });

            const dataInt = BigInt('0b' + binaryString);
            const encoded = base62.encode(dataInt);

            const url = new URL('print.html', window.location.href).href + '?b62=' + encoded;

            $('#qrcode').empty();
            new QRCode(document.getElementById("qrcode"), {
                text: url,
                width: 200,
                height: 200,
                correctLevel : QRCode.CorrectLevel.H
            });
        }
    </script>
</body>
</html>
